<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS para Notion con IA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
    </script>
    <style>
        :root {
            --primary-color: #4f46e5; --secondary-color: #6b7280; --bg-color: #f3f4f6;
            --surface-color: #ffffff; --border-color: #d1d5db; --text-color: #111827;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 2rem; display: flex; justify-content: center;
        }
        .container {
            max-width: 1100px; width: 100%; background-color: var(--surface-color);
            padding: 1.5rem 2.5rem; border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); border: 1px solid var(--border-color);
        }
        h1, h2 { font-weight: 700; }
        h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        h2 {
            font-size: 1.1rem; text-transform: uppercase; color: var(--secondary-color);
            margin-top: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);
        }
        p.subtitle { color: var(--secondary-color); margin-top: 0; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .form-section { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem; }
        label small { font-weight: 400; color: var(--secondary-color); }
        input, select {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px;
            box-sizing: border-box; font-size: 0.9rem; background-color: #f9fafb; transition: all 0.2s;
        }
        select[multiple] { height: 140px; padding: 0.5rem; }
        input:focus, select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); background-color: #fff;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem 1.5rem; }
        .button-group { display: flex; gap: 1rem; margin-top: 2rem; }
        .btn {
            flex: 1; padding: 1rem; font-size: 1rem; font-weight: 600; color: #fff;
            background-color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { background-color: #4338ca; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:disabled { background-color: #a5b4fc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn.secondary { background-color: var(--secondary-color); }
        .btn.secondary:hover { background-color: #4b5563; }
        .settings { padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .input-toggle { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
        .toggle-btn {
            flex: 1; padding: 0.75rem; background-color: var(--surface-color); border: none;
            cursor: pointer; font-size: 1rem; color: var(--secondary-color); transition: all 0.2s;
        }
        .toggle-btn.active { background-color: var(--primary-color); color: #fff; font-weight: 600; }
        #cv-url-input { display: none; }
        .message { padding: 1rem; border-radius: 8px; margin-top: 1.5rem; text-align: center; display: none; }
        .message.success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .message.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .message.info { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: #fff; padding: 2rem; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px;
            text-align: center;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content p { color: var(--secondary-color); }
        .modal-content a { color: var(--primary-color); font-weight: 600; text-decoration: none; }
        .modal-content a:hover { text-decoration: underline; }
        .modal-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
    </style>
</head>
<body>
<div class="container">
    <h1>ATS para Notion con IA üöÄ</h1>
    <p class="subtitle">Sube un CV o introduce una URL para que la IA extraiga la informaci√≥n. Luego, rev√≠sala y env√≠ala a Notion.</p>
    <div class="settings">
        <div class="grid">
            <div><label for="notion-token">Notion Integration Token</label><input type="password" id="notion-token" placeholder="Pega tu token de Notion aqu√≠"></div>
            <div><label for="gemini-key">Google AI (Gemini) API Key</label><input type="password" id="gemini-key" placeholder="Pega tu clave de API de Gemini aqu√≠"></div>
        </div>
    </div>
    <h2>1. Entrada y Configuraci√≥n</h2>
    <div class="form-section">
        <div class="grid"><div style="grid-column: 1 / -1;"><label>Fuente del Candidato</label><div class="input-toggle"><button class="toggle-btn active" id="toggle-file">Subir CV (PDF)</button><button class="toggle-btn" id="toggle-url">URL de LinkedIn (P√∫blica)</button></div><input type="file" id="cv-file-input" accept=".pdf" multiple><div id="upload-queue-container" style="display:none; margin-top: 1rem;"><label>Cola de Carga Manual</label><div id="upload-queue"></div></div><input type="url" id="cv-url-input" placeholder="https://www.linkedin.com/in/usuario/"></div></div>
        <div class="grid" style="margin-top: 1.5rem;">
            <div><label for="dd-stage">STAGE</label><select id="dd-stage"></select></div>
            <div><label for="dd-resolution">RESOLUTION</label><select id="dd-resolution"></select></div>
            <div><label for="dd-status">Status</label><select id="dd-status"></select></div>
            <div><label for="dd-source">SOURCE</label><select id="dd-source"></select></div>
            <div><label for="dd-gender">Gender</label><select id="dd-gender"></select></div>
            <div><label for="data-salary">SALARY EXPECTATION</label><input type="text" id="data-salary" placeholder="Ej: 50,000 EUR"></div>
        </div>
        <div class="grid" style="margin-top: 1.5rem;"><div style="grid-column: 1 / -1;"><label for="dd-languaje">LANGUAJE <small>(Mant√©n Ctrl/Cmd para seleccionar varios)</small></label><input type="text" id="languaje-search" placeholder="Buscar idioma..." style="margin-bottom: 0.5rem; background-color: #fff;"><select id="dd-languaje" multiple></select></div></div>
    </div>
    
    <div id="parsed-data-section">
        <h2>2. Datos del Candidato (Puedes editar antes de enviar)</h2>
        <div class="form-section"><div class="grid">
            <div><label for="data-name">Nombre y Apellido</label><input type="text" id="data-name"></div>
            <div><label for="data-email">Email</label><input type="email" id="data-email"></div>
            <div><label for="data-phone">Phone</label><input type="text" id="data-phone"></div>
            <div><label for="data-location">LOCATION</label><input type="text" id="data-location"></div>
            <div><label for="data-linkedin">LINKEDIN URL</label><input type="url" id="data-linkedin"></div>
            <div><label for="data-company">CURRENT COMPANY</label><input type="text" id="data-company"></div>
            <div style="grid-column: 1 / -1;"><label for="data-skills">Skills</label><input type="text" id="data-skills"></div>
        </div></div>
    </div>
    <div class="button-group"><button class="btn" id="send-btn">3. Enviar a Notion</button></div>
    <div id="message-box" class="message"></div>
</div>

<div id="duplicate-modal" class="modal-backdrop">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Candidato Duplicado</h3>
        <p id="modal-text"></p>
        <div class="modal-buttons">
            <button id="modal-cancel-btn" class="btn secondary">Anular</button>
            <button id="modal-confirm-btn" class="btn">Crear registro de todas formas</button>
        </div>
    </div>
</div>

<script>
// ---------- CONFIGURACI√ìN ----------
const NOTION_DATABASE_ID = "e6cf390e4b8546e8a5e0d25eba52d598";
const NOTION_API_URL = "https://api.notion.com/v1";
const GEMINI_API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=";

// ---------- ESTADO GLOBAL ----------
let fileQueue = [];
let currentData = {};

// ---------- ELEMENTOS DEL DOM ----------
const tokenInput = document.getElementById('notion-token'), geminiKeyInput = document.getElementById('gemini-key'),
      fileInput = document.getElementById('cv-file-input'), uploadQueueContainer = document.getElementById('upload-queue-container'),
      uploadQueue = document.getElementById('upload-queue'),
      languajeSearchInput = document.getElementById('languaje-search'),
      stageSelect = document.getElementById('dd-stage'), resolutionSelect = document.getElementById('dd-resolution'),
      statusSelect = document.getElementById('dd-status'), sourceSelect = document.getElementById('dd-source'),
      genderSelect = document.getElementById('dd-gender'), languajeSelect = document.getElementById('dd-languaje'),
      sendBtn = document.getElementById('send-btn'), messageBox = document.getElementById('message-box'),
      duplicateModal = document.getElementById('duplicate-modal'), modalText = document.getElementById('modal-text'),
      modalCancelBtn = document.getElementById('modal-cancel-btn'), modalConfirmBtn = document.getElementById('modal-confirm-btn'),
      dataFields = {
        name: document.getElementById('data-name'), email: document.getElementById('data-email'), phone: document.getElementById('data-phone'),
        location: document.getElementById('data-location'), linkedin: document.getElementById('data-linkedin'),
        company: document.getElementById('data-company'), skills: document.getElementById('data-skills'), 
        salary: document.getElementById('data-salary'),
      };

// ---------- L√ìGICA PRINCIPAL ----------
document.addEventListener('DOMContentLoaded', () => {
    tokenInput.value = localStorage.getItem('notionApiToken') || '';
    geminiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
    if (tokenInput.value) loadDropdownData();
    initializeUI();
});
tokenInput.addEventListener('change', () => { localStorage.setItem('notionApiToken', tokenInput.value); loadDropdownData(); });
geminiKeyInput.addEventListener('change', () => localStorage.setItem('geminiApiKey', geminiKeyInput.value));
languajeSearchInput.addEventListener('keyup', () => {
    const filter = languajeSearchInput.value.toLowerCase();
    Array.from(languajeSelect.options).forEach(opt => {
        opt.style.display = opt.textContent.toLowerCase().includes(filter) ? "" : "none";
    });
});
fileInput.addEventListener('change', (event) => {
    fileQueue = Array.from(event.target.files).map(file => ({ file, status: 'pending' }));
    renderQueue();
    toggleInputMode('file');
});
document.getElementById('toggle-file').addEventListener('click', () => toggleInputMode('file'));
document.getElementById('toggle-url').addEventListener('click', () => toggleInputMode('url'));

function initializeUI() {
    const mainActionsContainer = document.querySelector('.button-group');
    if (!mainActionsContainer) return;
    mainActionsContainer.innerHTML = ''; 

    const mode = document.getElementById('toggle-file').classList.contains('active') ? 'file' : 'url';
    
    if (mode === 'file' && fileQueue.length > 0) {
        // No hay botones globales, est√°n en la cola
    } else {
        const parseBtn = document.createElement('button');
        parseBtn.className = 'btn secondary';
        parseBtn.textContent = '2. Analizar con IA';
        parseBtn.addEventListener('click', handleSingleAnalysis);

        const sendBtnGlobal = document.getElementById('send-btn');
        sendBtnGlobal.textContent = '3. Enviar a Notion';
        
        mainActionsContainer.appendChild(parseBtn);
        mainActionsContainer.appendChild(sendBtnGlobal);
    }
}

function toggleInputMode(mode) {
    const toggleFileBtn = document.getElementById('toggle-file');
    const toggleUrlBtn = document.getElementById('toggle-url');
    const urlInput = document.getElementById('cv-url-input');
    
    const isFileMode = mode === 'file';
    toggleFileBtn.classList.toggle('active', isFileMode);
    toggleUrlBtn.classList.toggle('active', !isFileMode);
    
    fileInput.parentElement.style.display = isFileMode ? 'block' : 'none';
    uploadQueueContainer.style.display = isFileMode && fileQueue.length > 0 ? 'block' : 'none';
    urlInput.style.display = !isFileMode ? 'block' : 'none';
    
    initializeUI();
}

function showMessage(type, text, duration = 0) {
    messageBox.className = `message ${type}`; messageBox.textContent = text;
    messageBox.style.display = 'block';
    if (duration > 0) setTimeout(() => { messageBox.style.display = 'none'; }, duration);
}

async function handleSingleAnalysis() {
    const parseBtn = document.querySelector('.button-group .secondary');
    if(parseBtn) { parseBtn.disabled = true; parseBtn.textContent = 'Analizando...'; }
    showMessage('info', 'Iniciando an√°lisis...');
    
    try {
        if (!geminiKeyInput.value) throw new Error('La Clave de API de Gemini es necesaria.');
        let contentToParse = '';
        if (document.getElementById('toggle-file').classList.contains('active')) {
             const selectedFile = fileQueue.find(f => f.status === 'analyzing');
             if (!selectedFile) throw new Error('No hay un archivo seleccionado para analizar.');
             contentToParse = await extractTextFromPdf(selectedFile.file);
        } else {
            const url = document.getElementById('cv-url-input').value;
            if (!url) throw new Error('Por favor, introduce una URL.');
            contentToParse = `Extrae datos del perfil p√∫blico de LinkedIn: ${url}`;
        }
        showMessage('info', 'Contactando con la IA de Google...');
        currentData = await getAiParsedData(geminiKeyInput.value, contentToParse);
        populateFormFields(currentData);
        showMessage('success', 'An√°lisis completado.', 5000);
    } catch (error) {
        showMessage('error', `Error en el an√°lisis: ${error.message}`);
    } finally {
        if(parseBtn) { parseBtn.disabled = false; parseBtn.textContent = '2. Analizar con IA'; }
    }
}


async function handleSendToNotion() {
    sendBtn.disabled = true; sendBtn.textContent = 'Verificando...';
    if (!dataFields.name.value) {
        showMessage('error', "El campo 'Nombre y Apellido' es obligatorio.");
        sendBtn.disabled = false; sendBtn.textContent = '3. Enviar a Notion'; return;
    }
    const email = dataFields.email.value.trim();
    if (!email) { await proceedWithCreation(currentData); return; }
    try {
        const duplicates = await findDuplicateByEmail(email);
        if (duplicates.length > 0) {
            const existing = duplicates[0];
            const name = existing.properties["Nombre y Apellido"].title[0]?.plain_text || 'Sin Nombre';
            const url = existing.url;
            showDuplicateModal(name, url, currentData);
        } else { await proceedWithCreation(currentData); }
    } catch (error) {
        showMessage('error', `Error al verificar duplicados: ${error.message}`);
        sendBtn.disabled = false; sendBtn.textContent = '3. Enviar a Notion';
    }
}

async function proceedWithCreation(data, queueIndex = null) {
    const btn = queueIndex !== null ? document.getElementById(`send-${queueIndex}`) : sendBtn;
    if (btn) btn.textContent = 'Enviando...';

    try {
        const newPage = await createNotionEntry(data);
        showMessage('success', '¬°Candidato creado con √©xito!', 3000);
        if (newPage && newPage.url) window.open(newPage.url, '_blank');
        
        if (queueIndex !== null) {
            fileQueue[queueIndex].status = 'sent';
            renderQueue();
        } else {
            Object.values(dataFields).forEach(field => field.value = '');
            currentData = {};
        }
    } catch (error) {
        showMessage('error', `Error al enviar a Notion: ${error.message}`);
    } finally {
         if (btn && queueIndex === null) {
            btn.disabled = false;
            btn.textContent = '3. Enviar a Notion';
         }
    }
}
function showDuplicateModal(name, url, data, queueIndex) {
    modalText.innerHTML = `Ya existe un registro con este email a nombre de: <br><strong><a href="${url}" target="_blank">${name}</a></strong>`;
    duplicateModal.style.display = 'flex';
    
    const cancelHandler = () => {
        const btn = queueIndex !== null ? document.getElementById(`send-${queueIndex}`) : sendBtn;
        if (btn) { btn.disabled = false; btn.textContent = 'Enviar'; }
        cleanup();
    };
    const confirmHandler = async () => {
        await proceedWithCreation(data, queueIndex);
        cleanup();
    };
    const cleanup = () => {
        duplicateModal.style.display = 'none';
        modalCancelBtn.removeEventListener('click', cancelHandler);
        modalConfirmBtn.removeEventListener('click', confirmHandler);
    };

    modalCancelBtn.addEventListener('click', cancelHandler, { once: true });
    modalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
}

function populateFormFields(data) {
    currentData = data; // Guardar los datos analizados globalmente
    Object.keys(dataFields).forEach(key => {
        let value = '';
        if (key === 'skills') {
             let allSkills = [];
             if (data.skills_breakdown) {
                 const { job_titles = [], programming_languages = [], frameworks_libraries = [], databases = [] } = data.skills_breakdown;
                 allSkills = [...job_titles, ...programming_languages, ...frameworks_libraries, ...databases];
             }
             value = [...new Set(allSkills)].join(', ');
        } else if (data[key]) {
            value = data[key];
            if (key === 'phone') value = (value || '').replace(/[\s.-]/g, '');
        }
        
        if (key === 'salary' && dataFields.salary.value) return;
        dataFields[key].value = value;
    });
}

async function extractTextFromPdf(file) { /* ... (sin cambios) ... */ }
async function callApiProxy(targetUrl, method, apiHeaders, body = null) {
    const response = await fetch('/api/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: targetUrl, method, headers: apiHeaders, body })
    });
    const responseBodyText = await response.text();
    if (!response.ok) {
        throw new Error(`Error del Proxy (${response.status}): ${responseBodyText}`);
    }
    try {
        return JSON.parse(responseBodyText);
    } catch (e) {
        throw new Error("El proxy devolvi√≥ una respuesta que no era un JSON v√°lido.");
    }
}
async function getAiParsedData(apiKey, cvText) { /* ... (sin cambios) ... */ }
async function loadDropdownData() { /* ... (sin cambios) ... */ }
function populateSelect(selectElement, options, propertyName) { /* ... (sin cambios) ... */ }
async function findDuplicateByEmail(email) { /* ... (sin cambios) ... */ }

function renderQueue() {
    uploadQueueContainer.style.display = fileQueue.length > 0 ? 'block' : 'none';
    document.querySelector('.button-group')?.remove();
    uploadQueue.innerHTML = '';
    fileQueue.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'queue-item';
        div.innerHTML = `
            <span class="queue-item-name" title="${item.file.name}">${item.file.name}</span>
            <span id="status-${index}" class="queue-item-status status-${item.status}">${item.status}</span>
            <div class="button-group" style="flex: 0.5; margin: 0;">
                 <button id="analyze-${index}" class="btn btn-small secondary" ${item.status !== 'pending' ? 'disabled' : ''}>Analizar</button>
                 <button id="send-${index}" class="btn btn-small" ${item.status !== 'analyzed' ? 'disabled' : ''}>Enviar</button>
            </div>
        `;
        uploadQueue.appendChild(div);
        
        document.getElementById(`analyze-${index}`).addEventListener('click', (e) => handleQueueAnalyze(e, item, index));
        document.getElementById(`send-${index}`).addEventListener('click', () => handleSendToNotion(index));
    });
}

async function handleQueueAnalyze(event, item, index) {
    const analyzeBtn = event.target;
    const sendBtnQueue = document.getElementById(`send-${index}`);
    const statusEl = document.getElementById(`status-${index}`);
    
    analyzeBtn.disabled = true; analyzeBtn.textContent = '...';
    Object.values(dataFields).forEach(field => field.value = '');

    try {
        if (!geminiKeyInput.value) throw new Error('La Clave de API de Gemini es necesaria.');
        const contentToParse = await extractTextFromPdf(item.file);
        const parsedData = await getAiParsedData(geminiKeyInput.value, contentToParse);
        
        fileQueue[index].data = parsedData;
        fileQueue[index].status = 'analyzed';
        
        populateFormFields(parsedData);
        statusEl.className = 'queue-item-status status-success';
        statusEl.textContent = 'Analizado';
        sendBtnQueue.disabled = false;
        analyzeBtn.style.display = 'none';
    } catch (error) {
        showMessage('error', `Error al analizar ${item.file.name}: ${error.message}`);
        fileQueue[index].status = 'error';
        statusEl.className = 'queue-item-status status-error';
        statusEl.textContent = 'Error';
        analyzeBtn.style.display = 'none';
    }
}

async function createNotionEntry(data) {
    if (!data.name) throw new Error("El 'Nombre y Apellido' (extra√≠do de la IA) es obligatorio.");
    const properties = { "Nombre y Apellido": { title: [{ text: { content: data.name } }] } };
    
    let linkedInUrl = data.linkedin?.trim();
    if (linkedInUrl && !linkedInUrl.startsWith('http')) {
        linkedInUrl = `https://www.linkedin.com/in/${linkedInUrl.replace(/^\//, '')}`;
    }

    const addSelect = (pName, el) => { if (el.value) properties[pName] = { select: { name: el.value } }; };
    ['STAGE', 'RESOLUTION', 'SOURCE', 'Gender'].forEach(p => addSelect(p, document.getElementById(`dd-${p.toLowerCase()}`)));
    if (statusSelect.value) properties.Status = { status: { name: statusSelect.value } };
    const selectedLangs = Array.from(languajeSelect.options).filter(o => o.selected).map(o => ({ name: o.value }));
    if (selectedLangs.length > 0) properties.LANGUAJE = { multi_select: selectedLangs };
    
    const phoneVal = data.phone?.replace(/[\s.-]/g, '');
    if (phoneVal) properties.Phone = { phone_number: phoneVal };

    const addRichText = (pName, value) => { if (value) properties[pName] = { rich_text: [{ text: { content: value } }] }; };
    addRichText('LOCATION', data.location);
    addRichText('CURRENT COMPANY', data.company);
    addRichText('SALARY EXPECTATION', dataFields.salary.value); // Tomar siempre el valor manual
    
    if (data.email) properties.Email = { email: data.email };
    if (linkedInUrl) properties["LINKEDIN URL"] = { url: linkedInUrl };
    
    let allSkills = [];
    if (data.skills_breakdown) {
        const { job_titles = [], programming_languages = [], frameworks_libraries = [], databases = [] } = data.skills_breakdown;
        allSkills = [...job_titles, ...programming_languages, ...frameworks_libraries, ...databases];
    }
    const uniqueSkills = [...new Set(allSkills)];
    if (uniqueSkills.length > 0) properties.Skills = { multi_select: uniqueSkills.map(s => ({ name: s.trim() })).filter(s => s.name) };

    const headers = { 'Authorization': `Bearer ${tokenInput.value}`, 'Content-Type': 'application/json', 'Notion-Version': '2022-06-28' };
    return await callApiProxy(`${NOTION_API_URL}/pages`, 'POST', headers, { parent: { database_id: NOTION_DATABASE_ID }, properties });
}
</script>
</body>
</html>
